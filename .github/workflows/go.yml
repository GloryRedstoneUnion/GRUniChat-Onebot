# GitHub Actions Workflow for GRUniChat-OneBot Adapter
name: Build and Release

on:
  push:
    tags: [ 'v*' ]          # å½“æŽ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘å‘å¸ƒ
  pull_request:
    branches: [ "main" ]    # PRåˆ°mainåˆ†æ”¯æ—¶è§¦å‘æž„å»ºæµ‹è¯•

jobs:
  # æž„å»ºæµ‹è¯• Job
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: stable

    - name: Download dependencies
      run: go mod download

    - name: Build
      run: go build -v ./...

    - name: Test
      run: go test -v ./...

  # å‘å¸ƒ Job
  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: stable

    - name: Download dependencies
      run: go mod download

    - name: Set version info
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        echo "BUILDTIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

    - name: Create dist directory
      run: mkdir -p dist

    - name: Build for multiple platforms
      run: |
        # Windows builds
        GOOS=windows GOARCH=amd64 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-windows-amd64.exe .
        GOOS=windows GOARCH=arm64 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-windows-arm64.exe .
        
        # Linux builds
        GOOS=linux GOARCH=amd64 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-linux-amd64 .
        GOOS=linux GOARCH=arm64 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-linux-arm64 .
        GOOS=linux GOARCH=386 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-linux-386 .
        GOOS=linux GOARCH=arm go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-linux-arm .
        
        # macOS builds
        GOOS=darwin GOARCH=amd64 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-darwin-amd64 .
        GOOS=darwin GOARCH=arm64 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-darwin-arm64 .
        
        # FreeBSD builds
        GOOS=freebsd GOARCH=amd64 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-freebsd-amd64 .
        GOOS=freebsd GOARCH=arm64 go build -ldflags "-X main.Version=$VERSION -X main.BuildTime=$BUILDTIME" -o dist/GRUniChat-OneBot-Adapter-$VERSION-freebsd-arm64 .

    - name: Get release notes
      id: release_notes
      run: |
        if [ -f ".github/release/releasenote.md" ]; then
          echo "notes_file=.github/release/releasenote.md" >> $GITHUB_OUTPUT
        else
          # å¦‚æžœæ²¡æœ‰å‘å¸ƒè¯´æ˜Žæ–‡ä»¶ï¼Œä½¿ç”¨Gitæ ‡ç­¾æ³¨é‡Šæˆ–é»˜è®¤æ–‡æœ¬
          TAG_ANNOTATION=$(git tag -l --format='%(contents)' $VERSION)
          if [ -n "$TAG_ANNOTATION" ]; then
            echo "$TAG_ANNOTATION" > temp_release_notes.md
            echo "notes_file=temp_release_notes.md" >> $GITHUB_OUTPUT
          else
            cat > temp_release_notes.md << 'EOF'
        GRUniChat-OneBot Adapter $(echo $VERSION)
        
        ## ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
        
        è¿™æ˜¯ GRUniChat-OneBot é€‚é…å™¨çš„æ–°ç‰ˆæœ¬ã€‚
        
        ### ðŸ“¦ ä¸‹è½½
        
        è¯·é€‰æ‹©é€‚åˆæ‚¨ç³»ç»Ÿçš„ç‰ˆæœ¬è¿›è¡Œä¸‹è½½ï¼š
        
        | å¹³å° | æž¶æž„ | æ–‡ä»¶å |
        |------|------|--------|
        | Windows | x64 | GRUniChat-OneBot-Adapter-*-windows-amd64.exe |
        | Windows | ARM64 | GRUniChat-OneBot-Adapter-*-windows-arm64.exe |
        | Linux | x64 | GRUniChat-OneBot-Adapter-*-linux-amd64 |
        | Linux | ARM64 | GRUniChat-OneBot-Adapter-*-linux-arm64 |
        | macOS | Intel | GRUniChat-OneBot-Adapter-*-darwin-amd64 |
        | macOS | Apple Silicon | GRUniChat-OneBot-Adapter-*-darwin-arm64 |
        
        ### ðŸš€ å¿«é€Ÿå¼€å§‹
        
        1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶
        2. é¦–æ¬¡è¿è¡Œç¨‹åºï¼Œè‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ `config.yaml`
        3. æ ¹æ®æ‚¨çš„çŽ¯å¢ƒä¿®æ”¹é…ç½®æ–‡ä»¶
        4. å†æ¬¡è¿è¡Œç¨‹åºå³å¯å¼€å§‹ä½¿ç”¨
        
        è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒé¡¹ç›® README.mdã€‚
        EOF
            echo "notes_file=temp_release_notes.md" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: dist/*
        body_path: ${{ steps.release_notes.outputs.notes_file }}
        token: ${{ secrets.GITHUB_TOKEN }}
